#!/bin/bash
set -e

ENVIRONMENT_NAME=$1
PR_ID=$2

case $ENVIRONMENT_NAME in
  "production")
    SUBSCRIPTION_ID="9c2dcb72-4bba-4acc-8d5f-8b8389a68238"
    RESOURCE_GROUP="s165p01-rsm-pd-rg"
    NAME="s165p01-rsm-production-wkr-cg"
    ;;
  "preprod")
    SUBSCRIPTION_ID="250ff557-239a-4d89-83a4-07bdfc6218c7"
    RESOURCE_GROUP="s165t01-rsm-pp-rg"
    NAME="s165t01-rsm-preprod-wkr-cg"
    ;;
  "test")
    SUBSCRIPTION_ID="250ff557-239a-4d89-83a4-07bdfc6218c7"
    RESOURCE_GROUP="s165t01-rsm-ts-rg"
    NAME="s165t01-rsm-test-wkr-cg"
    ;;
  "dev")
    SUBSCRIPTION_ID="9816b7b0-58ca-4972-b25b-c7dbd3ee1c6d"
    RESOURCE_GROUP="s165d01-rsm-dv-rg"
    NAME="s165d01-rsm-dev-wkr-cg"
    ;;
  "review")
    SUBSCRIPTION_ID="9816b7b0-58ca-4972-b25b-c7dbd3ee1c6d"
    RESOURCE_GROUP="s165d01-rsm-review-pr-${PR_ID}-rg"
    NAME="s165d01-rsm-review-pr-${PR_ID}-wkr-cg"
    ;;
  *)
    echo "Could not find a known environment with the name: $ENVIRONMENT_NAME"
    exit 1
    ;;
esac

if [[ $ENVIRONMENT_NAME == "production" || $ENVIRONMENT_NAME == "test" ]]; then
  echo "**********************************************************************************************************************"
  echo "You will need to make a PIM request to access the console"
  echo "Visit https://portal.azure.com/#blade/Microsoft_Azure_PIMCommon/ActivationMenuBlade/azurerbac"
  echo "and activate the 'Contributor' role for the 's165-teachingqualificationsservice-$ENVIRONMENT_NAME' environment."
  echo "Once this has been approved, press enter to continue"
  echo "**********************************************************************************************************************"

  read -p "" -r

  echo "Logging out of Azure and back in to grab new tokens"
  if az account show > /dev/null; then
    az logout > /dev/null
  fi
  echo "**********************************************************************************************************************"
fi

if ! az account show > /dev/null; then
  az login > /dev/null
fi

if [[ $ENVIRONMENT_NAME == "production" ]]; then
  echo "**********************************************************************************************************************"
  echo "IMPORTANT: Accessing the $ENVIRONMENT_NAME console in this way is VERY risky and should only be done as a last resort"
  echo "Mutating any live data is STRONGLY discouraged."
  echo "**********************************************************************************************************************"

  echo
  read -p "Are you sure you want to continue? (y/n)" -n 1 -r
  echo

  if ! [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Quitting"
    exit 0
  fi

  SANDBOX_OPTION="--sandbox"
fi

az account set --subscription "$SUBSCRIPTION_ID"

az container exec \
  --name=$NAME \
  --resource-group=$RESOURCE_GROUP \
  --exec-command="bundle exec rails c $SANDBOX_OPTION"
