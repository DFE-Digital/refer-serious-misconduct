# frozen_string_literal: true

require "rails_helper"

RSpec.describe FetchMalwareScanResultsJob do
  describe "#perform" do
    subject(:perform) { described_class.perform_now }

    let(:malware_scan) { instance_double(Malware::FetchScanResult, call: true) }

    before do
      allow(FeatureFlags::FeatureFlag).to receive(:active?).with(:malware_scan).and_return(true)
      allow(Malware::FetchScanResult).to receive(:new).and_return(malware_scan)
    end

    context "with a stale pending upload" do
      let!(:upload) do
        create(:upload, :allegation, malware_scan_result: "pending", created_at: 10.minutes.ago)
      end

      it "fetches malware scan results" do
        expect(Malware::FetchScanResult).to receive(:new).with(upload:)

        perform
      end
    end

    context "with a fresh pending upload" do
      before { create(:upload, :allegation, malware_scan_result: "pending") }

      it "does not fetch malware scan results" do
        expect(Malware::FetchScanResult).not_to receive(:new)

        perform
      end
    end
  end
end
