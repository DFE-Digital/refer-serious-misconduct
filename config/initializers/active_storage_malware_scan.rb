module ActiveStorageMalwareScanExtension
  extend ActiveSupport::Concern

  included do
    after_create_commit :malware_scan

    enum malware_scan_result: {
      clean: "clean",
      error: "error",
      pending: "pending",
      enqueued: "enqueued",
      suspect: "suspect",
    },
    _prefix: :scan_result
  end

  def malware_scan
    scannable_fields = %w[allegation_upload duties_upload previous_misconduct_upload document]

    attachments.each do |attachment|
      next unless scannable_fields.include?(attachment.name.to_s)
      next if attachment.blob.scan_result_enqueued?

      attachment.blob.scan_result_enqueued!

      FetchMalwareScanResultJob.set(wait: 10.seconds).perform_later(
        blob_id: attachment.blob.id
      )
    end
  end
end

Rails.configuration.to_prepare do
  ActiveStorage::Blob.include ActiveStorageMalwareScanExtension
end
