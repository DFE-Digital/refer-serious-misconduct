<% content_for :page_title, "Manage teacher misconduct referrals" %>

<% content_for :breadcrumbs do %>
  <%= govuk_breadcrumbs(breadcrumbs: {
    "Referrals" => manage_interface_referrals_path,
    @referral.name => nil
  }) %>
<% end %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds-from-desktop">
    <span class="govuk-caption-l"><%= @referral.id %></span>
    <h1 class="govuk-heading-l"><%= @referral.name %></h1>

    <div class="app-panel">
      <% if @referral.has_attachments? %>
        <p class="govuk-body">
          <%= govuk_link_to "Download referral (ZIP)", manage_interface_referral_path(format: :zip) %>
        </p>
      <% end %>
    </div>

    <div class="app-panel" id="summary">
      <h2 class="govuk-heading-m">Summary</h2>

      <%= govuk_summary_list(rows: [
        { key: { text: "Referral ID" }, value: { text: @referral.id } },
        { key: { text: "Referral date" }, value: { text: @referral.created_at.to_fs(:day_month_year_time) } }
      ])
      %>
    </div>

    <div class="app-panel" id="personal_details">
      <h2 class="govuk-heading-m">Personal details</h2>
      <% personal_rows = [
        { key: { text: "First name" }, value: { text: @referral.first_name } },
        { key: { text: "Last name" }, value: { text: @referral.last_name } },
      ]
        personal_rows << { key: { text: "Do they have qualified teacher status?" }, value: { text: @referral.has_qts&.humanize } } if @referral.from_employer?
      %>
      <%= govuk_summary_list(rows: personal_rows) %>
    </div>

    <div class="app-panel" id="employment_details">
      <h2 class="govuk-heading-m">Employment details</h2>
      <% 
        employment_rows = [
          { key: { text: "Job title" }, value: { text: @referral.job_title || "Not known" } },
          { key: { text: "Main duties" }, value: { text: duties_details(@referral) } },
        ] 
        if @referral.from_employer?
          employment_rows.push({ key: { text: "Organisation" }, value: { text: @referral.same_organisation? ? organisation_address(@referral.organisation) : referral_organisation_address(@referral) } })
          employment_rows.push({ key: { text: "Job start date" }, value: { text: @referral.role_start_date&.to_fs(:long_ordinal_uk) }}) if @referral.role_start_date_known
          employment_rows.push({ key: { text: "Job end date" }, value: { text: @referral.role_end_date&.to_fs(:long_ordinal_uk) }}) if @referral.role_end_date_known
          employment_rows.push({ key: { text: "Reason they left the job" }, value: { text: @referral.reason_leaving_role&.humanize }})
        end
      %>
      <%= govuk_summary_list(rows: employment_rows) %>
    </div>

    <% if @referral.from_employer? %>
      <div class="app-panel" id="other_employment_details">
        <h2 class="govuk-heading-m">Other employment details</h2>
        <%= govuk_summary_list(rows: [
          { key: { text: "Organisation" }, value: { text: teaching_address(@referral) } }
        ]) %>
      </div>
    <% end %>

    <div class="app-panel" id="allegation_details">
      <h2 class="govuk-heading-m">Allegation details</h2>
      <%= govuk_summary_list(rows: [
        { key: { text: "Allegation details" }, value: { text: allegation_details(@referral) } },
        { key: { text: "Have you told the Disclosure and Barring Service (DBS)?" }, value: { text: @referral.dbs_notified ? "Yes" : "No" } },
      ]) %>
    </div>

    <div class="app-panel" id="evidence">
      <h2 class="govuk-heading-m">Evidence and supporting information</h2>
      <% if @referral.evidences.any? %>
        <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">
          <% @referral.evidences.map do |evidence| %>
            <li class="govuk-!-margin-bottom-0">
              <%= govuk_link_to(evidence.filename, rails_blob_path(evidence.document, disposition: "attachment")) %>
            </li>
          <% end %>
        </ul>
      <% end %>
    </div>

    <% if @referral.from_employer? %>
      <div class="app-panel" id="previous_allegation_details">
        <h2 class="govuk-heading-m">Previous allegation details</h2>
        <%= govuk_summary_list(rows: [
          { key: { text: "Has there been any previous misconduct?" }, value: { text: humanize_three_way_choice(@referral.previous_misconduct_reported) } },
          { key: { text: "Previous allegation details" }, value: { text: previous_allegation_details(@referral) } },
        ]) %>
      </div>
    <% end %>

    <div class="app-panel" id="referrer_details">
      <h2 class="govuk-heading-m">Referrer details</h2>
      <% 
        referrer_rows = [
          { key: { text: "First name" }, value: { text: @referral.referrer.first_name } },
          { key: { text: "Last name" }, value: { text: @referral.referrer.last_name } },
        ] 
        referrer_rows.push({ key: { text: "Job title" }, value: { text: @referral.referrer.job_title } }) if @referral.from_employer?
        referrer_rows.push({ key: { text: "Email address" }, value: { text: @referral.user.email } })
        referrer_rows.push({ key: { text: "Phone number" }, value: { text: @referral.referrer.phone } })
        referrer_rows.push({ key: { text: "Employer" }, value: { text: organisation_address(@referral.organisation) } }) if @referral.from_employer?
      %>
      <%= govuk_summary_list(rows: referrer_rows) %>
    </div>
  </div>
</div>
